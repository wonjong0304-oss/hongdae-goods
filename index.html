<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÌôçÎåÄ ÍµøÏ¶àÏÉµ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé≠</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-overflow-scrolling: touch; }
        
        :root {
            --bg: #000;
            --card: #1c1c1e;
            --text: #fff;
            --text-sub: #8e8e93;
            --primary: #007aff;
            --success: #30d158;
            --danger: #ff453a;
            --warning: #ff9f0a;
        }

        body.light-mode {
            --bg: #f2f2f7;
            --card: #fff;
            --text: #000;
            --text-sub: #6e6e73;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Pretendard', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            line-height: 1.4;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        html {
            height: -webkit-fill-available;
        }

        /* Ïù∏Ìä∏Î°ú */
        .intro {
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, #0a0a1a 0%, #1a1a2e 50%, #000 100%);
            z-index: 300;
            display: flex;
            flex-direction: column;
            padding: 60px 28px 40px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        body.light-mode .intro {
            background: linear-gradient(180deg, #e8e8f0 0%, #d8d8e8 50%, #f2f2f7 100%);
        }
        .intro.hidden { display: none; }

        .intro-top {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .theme-toggle {
            padding: 8px 14px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 20px;
            font-size: 14px;
            color: var(--text);
            cursor: pointer;
        }
        body.light-mode .theme-toggle {
            background: rgba(0,0,0,0.1);
        }

        .intro-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .intro-emoji {
            font-size: 72px;
            margin-bottom: 28px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .intro-title {
            font-size: 32px;
            font-weight: 800;
            line-height: 1.3;
            margin-bottom: 32px;
        }
        .intro-title .highlight { color: var(--primary); }

        .intro-benefits {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin-bottom: 40px;
        }

        .benefit-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        body.light-mode .benefit-item {
            background: rgba(0,0,0,0.03);
            border-color: rgba(0,0,0,0.1);
        }

        .benefit-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary), #5856d6);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .benefit-text .main { font-size: 16px; font-weight: 700; }
        .benefit-text .sub { font-size: 13px; color: var(--text-sub); }

        .intro-cta {
            width: 100%;
            padding: 18px;
            background: var(--primary);
            border: none;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            cursor: pointer;
            margin-bottom: 12px;
        }

        .intro-skip {
            width: 100%;
            padding: 14px;
            background: var(--card);
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
        }

        .intro-footer {
            text-align: center;
            font-size: 13px;
            color: var(--text-sub);
            margin-top: 16px;
        }

        /* Ïò®Î≥¥Îî© */
        .onboarding {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 200;
            display: none;
            flex-direction: column;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .onboarding.show { display: flex; }

        .onboarding-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin-right: 16px;
        }
        body.light-mode .progress-bar { background: #ddd; }
        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.3s;
        }

        .skip-btn {
            font-size: 15px;
            color: var(--text-sub);
            background: none;
            border: none;
            cursor: pointer;
        }

        .onboarding-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px 24px 40px;
        }

        .question-num {
            font-size: 14px;
            color: var(--primary);
            font-weight: 700;
            margin-bottom: 12px;
        }

        .question-text {
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 32px;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-btn {
            padding: 18px 20px;
            background: var(--card);
            border: 2px solid #333;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            transition: all 0.2s;
        }
        body.light-mode .option-btn { border-color: #ddd; }
        .option-btn:active { transform: scale(0.98); }
        .option-btn.selected { border-color: var(--primary); background: rgba(0,122,255,0.15); }

        .option-icon {
            font-size: 28px;
            width: 44px;
            height: 44px;
            background: #333;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        body.light-mode .option-icon { background: #eee; }
        .option-btn.selected .option-icon { background: var(--primary); }

        .option-text { flex: 1; }
        .option-text .main { display: block; margin-bottom: 2px; }
        .option-text .sub { font-size: 13px; color: var(--text-sub); font-weight: 400; }

        /* Í≤∞Í≥º ÌôîÎ©¥ */
        .result-screen {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 200;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .result-screen.show { display: flex; }

        .result-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #222;
            flex-shrink: 0;
        }
        body.light-mode .result-header { border-color: #ddd; }

        .back-btn {
            width: 40px;
            height: 40px;
            background: var(--card);
            border: none;
            border-radius: 12px;
            font-size: 20px;
            cursor: pointer;
            color: var(--text);
        }
        .result-header h1 { font-size: 18px; font-weight: 700; }

        .result-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px;
            padding-bottom: 100px;
        }

        .ai-card {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 1px solid #334;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
        }
        body.light-mode .ai-card {
            background: linear-gradient(135deg, #e8e8f8, #d8d8f0);
            border-color: #ccc;
        }

        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 16px;
        }

        .ai-title { font-size: 24px; font-weight: 800; margin-bottom: 8px; }
        .ai-desc { font-size: 15px; color: var(--text-sub); margin-bottom: 20px; }

        .ai-reasons {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 16px;
        }
        body.light-mode .ai-reasons { background: rgba(0,0,0,0.05); }
        .ai-reasons-title { font-size: 13px; font-weight: 700; color: var(--text-sub); margin-bottom: 12px; }
        .reason-item { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px; font-size: 14px; }
        .reason-item:last-child { margin-bottom: 0; }
        .reason-icon { width: 20px; height: 20px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; color: #fff; }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-sub);
            margin-bottom: 14px;
            display: flex;
            justify-content: space-between;
        }
        .shop-count { color: var(--primary); }

        /* Í∞ÄÍ≤å Ïπ¥Îìú */
        .shop-card {
            background: var(--card);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 12px;
            cursor: pointer;
        }
        .shop-card:active { transform: scale(0.98); }
        .shop-card.first { border: 1px solid rgba(0,122,255,0.3); }

        .shop-photo {
            width: 100%;
            height: 100px;
            background: linear-gradient(135deg, #2c2c2e 0%, #1c1c1e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            position: relative;
        }
        body.light-mode .shop-photo {
            background: linear-gradient(135deg, #e8e8e8 0%, #d8d8d8 100%);
        }

        .shop-status {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
        }
        .shop-status.open { background: var(--success); color: #fff; }
        .shop-status.closed { background: var(--danger); color: #fff; }
        .shop-status.soon { background: var(--warning); color: #000; }

        .shop-rank-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 800;
            color: #fff;
        }

        .shop-body { padding: 14px; }

        .shop-name-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .shop-name { font-size: 17px; font-weight: 700; }

        .shop-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            color: var(--text-sub);
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .shop-genres {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .genre-tag {
            padding: 4px 10px;
            background: #333;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #a78bfa;
        }
        body.light-mode .genre-tag { background: #e8e8f8; }

        /* ÌïòÎã® Î≤ÑÌäº */
        .result-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 20px 32px;
            background: var(--bg);
            border-top: 1px solid #222;
        }
        body.light-mode .result-footer { border-color: #ddd; }

        .start-btn {
            width: 100%;
            padding: 18px;
            background: var(--primary);
            border: none;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 700;
            color: #fff;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .secondary-btns { display: flex; gap: 10px; }
        .sec-btn {
            flex: 1;
            padding: 14px;
            background: var(--card);
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
        }

        /* Î©îÏù∏ Ïï± */
        .app {
            display: none;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
        }
        .app.show { display: flex; }

        .current-dest {
            background: var(--card);
            padding: 20px;
            border-bottom: 1px solid #333;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            max-height: 45vh;
        }
        body.light-mode .current-dest { border-color: #ddd; }

        .dest-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-sub);
            margin-bottom: 12px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        .stamps { display: flex; gap: 6px; margin-left: auto; }
        .stamp {
            width: 24px;
            height: 24px;
            background: #333;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: #fff;
        }
        body.light-mode .stamp { background: #ddd; color: #000; }
        .stamp.done { background: var(--success); color: #fff; }
        .stamp.current { background: var(--primary); color: #fff; animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0,122,255,0.5); }
            50% { box-shadow: 0 0 0 8px rgba(0,122,255,0); }
        }

        .dest-shop {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 14px;
        }

        .dest-photo {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, #007aff33, #5856d633);
            border: 2px solid var(--primary);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            flex-shrink: 0;
        }

        .dest-info { flex: 1; min-width: 0; }
        .dest-info h2 { font-size: 20px; font-weight: 800; margin-bottom: 4px; }
        .dest-info p { font-size: 14px; color: var(--text-sub); }

        .dest-walk {
            padding: 8px 14px;
            background: var(--primary);
            border-radius: 20px;
            font-size: 15px;
            font-weight: 700;
            color: #fff;
            flex-shrink: 0;
        }

        .dest-status-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #262628;
            border-radius: 12px;
            margin-bottom: 14px;
        }
        body.light-mode .dest-status-bar { background: #e8e8e8; }
        .dest-status-bar .status {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            color: #fff;
        }
        .dest-status-bar .status.open { background: var(--success); }
        .dest-status-bar .status.closed { background: var(--danger); }
        .dest-status-bar .hours { font-size: 14px; color: var(--text-sub); }

        .dest-genres {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 14px;
        }

        .dest-actions { display: flex; gap: 10px; }
        .action-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            color: #fff;
        }
        .action-btn.primary { background: var(--primary); }
        .action-btn.secondary { background: #333; }
        body.light-mode .action-btn.secondary { background: #ddd; color: #000; }
        .action-btn.success { background: var(--success); }
        .action-btn.danger { background: var(--danger); }

        /* ÏßÄÎèÑ */
        .map-container { flex: 1; position: relative; min-height: 200px; }
        #map, #freeMap { width: 100%; height: 100%; }

        .map-status {
            position: absolute;
            top: 16px;
            left: 16px;
            right: 16px;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            border-radius: 14px;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10;
        }
        body.light-mode .map-status { background: rgba(255,255,255,0.9); }
        .map-status-icon {
            width: 44px;
            height: 44px;
            background: var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }
        .map-status-text { flex: 1; }
        .map-status-text .title { font-size: 15px; font-weight: 700; }
        .map-status-text .sub { font-size: 13px; color: var(--text-sub); }
        .map-status-badge {
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            color: #fff;
        }
        .map-status-badge.open { background: var(--success); }
        .map-status-badge.closed { background: var(--danger); }

        .map-btn {
            position: absolute;
            width: 48px;
            height: 48px;
            background: var(--card);
            border: none;
            border-radius: 50%;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 10;
        }
        .loc-btn { bottom: 100px; right: 16px; }
        .theme-btn { bottom: 160px; right: 16px; font-size: 18px; }

        .next-preview {
            position: absolute;
            bottom: 16px;
            left: 16px;
            right: 16px;
            background: var(--card);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 10;
        }
        .next-icon {
            width: 48px;
            height: 48px;
            background: #333;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        body.light-mode .next-icon { background: #e8e8e8; }
        .next-info { flex: 1; }
        .next-info .label { font-size: 12px; color: var(--text-sub); font-weight: 600; }
        .next-info h4 { font-size: 16px; font-weight: 700; }
        .next-walk { font-size: 15px; font-weight: 700; color: var(--primary); }

        /* ÏûêÏú† ÌÉêÎ∞© Î™®Îìú */
        .free-mode-header {
            background: var(--card);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #333;
        }
        body.light-mode .free-mode-header { border-color: #ddd; }
        .free-mode-header h1 { font-size: 18px; font-weight: 700; }
        .free-mode-header .close-btn {
            width: 36px;
            height: 36px;
            background: #333;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            color: var(--text);
        }
        body.light-mode .free-mode-header .close-btn { background: #e8e8e8; }

        .free-mode-stats {
            display: flex;
            gap: 12px;
            padding: 12px 20px;
            background: #111;
            overflow-x: auto;
        }
        body.light-mode .free-mode-stats { background: #e8e8e8; }
        .stat-item {
            padding: 8px 14px;
            background: var(--card);
            border-radius: 10px;
            font-size: 13px;
            white-space: nowrap;
        }
        .stat-item strong { color: var(--primary); }

        /* Î™®Îã¨ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 100;
            display: none;
            align-items: flex-end;
        }
        .modal-overlay.show { display: flex; }

        .modal {
            background: var(--card);
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .modal-handle { width: 36px; height: 4px; background: #444; border-radius: 2px; margin: 10px auto; }
        body.light-mode .modal-handle { background: #ccc; }
        .modal-content { padding: 0 20px 32px; }

        .modal-photo {
            width: 100%;
            height: 140px;
            background: linear-gradient(135deg, #2c2c2e, #1c1c1e);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 56px;
            margin-bottom: 20px;
            position: relative;
        }
        body.light-mode .modal-photo {
            background: linear-gradient(135deg, #e8e8e8, #d8d8d8);
        }
        .modal-status {
            position: absolute;
            bottom: 12px;
            left: 12px;
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            color: #fff;
        }
        .modal-status.open { background: var(--success); }
        .modal-status.closed { background: var(--danger); }

        .modal-title-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        .modal-title { font-size: 24px; font-weight: 800; }

        .modal-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: var(--text-sub);
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .modal-genres {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .modal-info {
            background: #262628;
            border-radius: 14px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        body.light-mode .modal-info { background: #e8e8e8; }
        .modal-info-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-bottom: 1px solid #333;
            font-size: 15px;
        }
        body.light-mode .modal-info-row { border-color: #ddd; }
        .modal-info-row:last-child { border-bottom: none; }
        .modal-info-row .icon { font-size: 18px; width: 24px; text-align: center; }

        /* ÌïúÏ§ÑÌèâ */
        .review-section {
            margin-bottom: 20px;
        }
        .review-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-sub);
            margin-bottom: 12px;
        }
        .review-input-wrap {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .review-input {
            flex: 1;
            padding: 12px 16px;
            background: #262628;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            color: var(--text);
        }
        body.light-mode .review-input { background: #e8e8e8; }
        .review-input::placeholder { color: var(--text-sub); }
        .review-submit {
            padding: 12px 16px;
            background: var(--primary);
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            cursor: pointer;
        }
        .review-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .review-item {
            padding: 12px;
            background: #262628;
            border-radius: 10px;
            font-size: 14px;
        }
        body.light-mode .review-item { background: #e8e8e8; }
        .review-item .date {
            font-size: 11px;
            color: var(--text-sub);
            margin-top: 4px;
        }

        .modal-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .modal-btn {
            flex: 1;
            min-width: 100px;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            color: #fff;
        }
        .modal-btn.primary { background: var(--primary); }
        .modal-btn.secondary { background: #333; }
        body.light-mode .modal-btn.secondary { background: #ddd; color: #000; }
        .modal-btn.success { background: var(--success); }
        .modal-btn.danger { background: var(--danger); }

        /* ÏôÑÎ£å ÌôîÎ©¥ */
        .complete-screen {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 150;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .complete-screen.show { display: flex; }

        .complete-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #222;
            flex-shrink: 0;
        }
        body.light-mode .complete-header { border-color: #ddd; }
        .complete-header h2 { font-size: 24px; font-weight: 800; }
        .complete-header p { font-size: 14px; color: var(--text-sub); margin-top: 4px; }

        .complete-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px;
        }

        .complete-shop-card {
            background: var(--card);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .complete-shop-icon {
            width: 52px;
            height: 52px;
            background: var(--success);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
        }
        .complete-shop-info { flex: 1; }
        .complete-shop-info h3 { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
        .complete-shop-info p { font-size: 13px; color: var(--text-sub); }

        .complete-footer {
            padding: 16px 20px 32px;
            border-top: 1px solid #222;
            flex-shrink: 0;
        }
        body.light-mode .complete-footer { border-color: #ddd; }

        .complete-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 10px;
            color: #fff;
        }
        .complete-btn.primary { background: var(--primary); }
        .complete-btn.secondary { background: #333; }
        body.light-mode .complete-btn.secondary { background: #ddd; color: #000; }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            z-index: 500;
            display: none;
            color: #fff;
        }
        body.light-mode .toast { background: #333; }
        .toast.show { display: block; }
    </style>
</head>
<body>

<!-- Ïù∏Ìä∏Î°ú -->
<div class="intro" id="intro">
    <div class="intro-top">
        <button class="theme-toggle" onclick="toggleTheme()">üåô Îã§ÌÅ¨Î™®Îìú</button>
    </div>
    <div class="intro-content">
        <div class="intro-emoji">üé≠</div>
        <h1 class="intro-title">
            ÌôçÎåÄ ÎçïÏßà,<br>
            <span class="highlight">Ïñ¥ÎîîÎ∂ÄÌÑ∞ Í∞ÄÏïº Ìï†ÏßÄ</span><br>
            ÎßâÎßâÌñàÎã§Î©¥?
        </h1>
        <div class="intro-benefits">
            <div class="benefit-item">
                <div class="benefit-icon">üéØ</div>
                <div class="benefit-text">
                    <div class="main">ÎÇ¥ Ï∑®Ìñ• ÎßûÏ∂§ Î£®Ìä∏</div>
                    <div class="sub">ÏïôÏä§ÌÉÄ, Î∏îÎ£®Î°ù, ÌîºÍ∑úÏñ¥ Ï∑®Ìñ•Î≥Ñ Ï∂îÏ≤ú</div>
                </div>
            </div>
            <div class="benefit-item">
                <div class="benefit-icon">‚è∞</div>
                <div class="benefit-text">
                    <div class="main">ÏòÅÏóÖÏ§ëÏù∏ Í≥≥Îßå</div>
                    <div class="sub">ÏßÄÍ∏à Ïó¥Î†§ÏûàÎäî Í∞ÄÍ≤å Ïã§ÏãúÍ∞Ñ ÌôïÏù∏</div>
                </div>
            </div>
            <div class="benefit-item">
                <div class="benefit-icon">üìç</div>
                <div class="benefit-text">
                    <div class="main">Î∞©Î¨∏ Í∏∞Î°ù Ï†ÄÏû•</div>
                    <div class="sub">Îã§ÎÖÄÏò® Í≥≥ Ï≤¥ÌÅ¨ÌïòÍ≥† ÏÉàÎ°úÏö¥ Í≥≥ Î∞úÍ≤¨</div>
                </div>
            </div>
        </div>
    </div>
    <button class="intro-cta" onclick="startOnboarding()">üéØ ÎßûÏ∂§ ÏΩîÏä§ Ï∂îÏ≤úÎ∞õÍ∏∞</button>
    <button class="intro-skip" onclick="startFreeMode()">üó∫ ÏûêÏú†Î°≠Í≤å ÎëòÎü¨Î≥¥Í∏∞</button>
    <div class="intro-footer">25Í∞ú ÍµøÏ¶àÏÉµ Ï†ïÎ≥¥ ÏàòÎ°ù</div>
</div>

<!-- Ïò®Î≥¥Îî© -->
<div class="onboarding" id="onboarding">
    <div class="onboarding-header">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <button class="skip-btn" onclick="skipOnboarding()">Í±¥ÎÑàÎõ∞Í∏∞</button>
    </div>
    <div class="onboarding-content" id="questionContent"></div>
</div>

<!-- Í≤∞Í≥º ÌôîÎ©¥ -->
<div class="result-screen" id="resultScreen">
    <div class="result-header">
        <button class="back-btn" onclick="backToOnboarding()">‚Üê</button>
        <h1>ÎßûÏ∂§ Ï∂îÏ≤ú</h1>
    </div>
    <div class="result-content" id="resultContent"></div>
    <div class="result-footer">
        <button class="start-btn" onclick="startTour()">üöÄ ÌÉêÎ∞© ÏãúÏûë</button>
        <div class="secondary-btns">
            <button class="sec-btn" onclick="backToOnboarding()">üîÑ Îã§Ïãú ÏÑ†ÌÉù</button>
            <button class="sec-btn" onclick="shareCourse()">üì§ Í≥µÏú†</button>
        </div>
    </div>
</div>

<!-- Î©îÏù∏ Ïï± (ÏΩîÏä§ Î™®Îìú) -->
<div class="app" id="app">
    <div class="current-dest" id="currentDest"></div>
    <div class="map-container">
        <div id="map"></div>
        <div class="map-status" id="mapStatus"></div>
        <button class="map-btn theme-btn" onclick="toggleTheme()">üåô</button>
        <button class="map-btn loc-btn" onclick="goToMyLocation()">üìç</button>
        <div class="next-preview" id="nextPreview"></div>
    </div>
</div>

<!-- ÏûêÏú† ÌÉêÎ∞© Î™®Îìú -->
<div class="app" id="freeApp">
    <div class="free-mode-header">
        <h1>üó∫ Ï†ÑÏ≤¥ ÍµøÏ¶àÏÉµ</h1>
        <button class="close-btn" onclick="closeFreeMode()">‚úï</button>
    </div>
    <div class="free-mode-stats" id="freeStats"></div>
    <div class="map-container">
        <div id="freeMap" style="width:100%;height:100%;"></div>
        <button class="map-btn theme-btn" onclick="toggleTheme()">üåô</button>
        <button class="map-btn loc-btn" onclick="goToMyLocationFree()">üìç</button>
    </div>
</div>

<!-- Î™®Îã¨ -->
<div class="modal-overlay" id="modal" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-handle"></div>
        <div class="modal-content" id="modalContent"></div>
    </div>
</div>

<!-- ÏôÑÎ£å -->
<div class="complete-screen" id="completeScreen">
    <div class="complete-header">
        <h2>üéâ ÌÉêÎ∞© ÏôÑÎ£å!</h2>
        <p id="completeSubtext">Ïò§Îäò Îã§ÎÖÄÏò® Í≥≥Îì§</p>
    </div>
    <div class="complete-content" id="completeContent"></div>
    <div class="complete-footer">
        <button class="complete-btn primary" onclick="viewAllMap()">üó∫ Ï†ÑÏ≤¥ ÏßÄÎèÑÎ°ú Î≥¥Í∏∞</button>
        <button class="complete-btn secondary" onclick="resetApp()">üîÑ Ï≤òÏùåÏúºÎ°ú</button>
    </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDOht0k-HMZ1V2kLPMj3Ho627PGoNgWkAg&callback=initApp&language=ko" async defer></script>

<script>
// Í∞ÄÍ≤å Îç∞Ïù¥ÌÑ∞ - AKÌîåÎùºÏûê Ï¢åÌëú ÏàòÏ†ï (ÌôçÎåÄÏûÖÍµ¨Ïó≠ 4Î≤àÏ∂úÍµ¨ ÏúÑ)
const shops = [
    {id:1, name:"Ïï†ÎãàÎ©îÏù¥Ìä∏ ÌôçÎåÄÏ†ê", address:"AKÌîåÎùºÏûê 5Ï∏µ", hours:"11:00-21:40", lat:37.55658, lng:126.92366, icon:"üé≠", type:"Ï¢ÖÌï©", genres:["ÏïôÏä§ÌÉÄ","Î∏îÎ£®Î°ù","ÌîºÍ∑úÏñ¥","Ïó¨ÏÑ±Ìñ•","ÎÇ®ÏÑ±Ìñ•"]},
    {id:2, name:"Î™®ÏôÄÏ¶ê", address:"ÏôÄÏö∞ÏÇ∞Î°ú21Í∏∏ 28", hours:"12:00-20:00", lat:37.55211, lng:126.92094, icon:"üíñ", type:"Ïó¨ÏÑ±Ìñ•", genres:["ÏïôÏä§ÌÉÄ","Î∏îÎ£®Î°ù","ÏßÑÍ≤©","Ïù¥ÏπòÎ∞©Ïø†ÏßÄ"]},
    {id:3, name:"ÏµúÏï†ÍµøÏ¶à", address:"ÏûîÎã§Î¶¨Î°ú 13 B1", hours:"12:00-21:00", lat:37.55330, lng:126.92100, icon:"üíù", type:"Ï§ëÍ≥†", genres:["ÏïôÏä§ÌÉÄ","Ïó¨ÏÑ±Ìñ•","Ï§ëÍ≥†"]},
    {id:4, name:"ÏãúÎ°úÏÉÅÏ†ê", address:"ÏôÄÏö∞ÏÇ∞Î°ú29Í∏∏ B1", hours:"12:00-21:00", lat:37.55269, lng:126.92152, icon:"‚ú®", type:"Ï¢ÖÌï©", genres:["Ìä∏Î†åÎìú","Í∞ÄÏ±†","Ïó¨ÏÑ±Ìñ•","ÎÇ®ÏÑ±Ìñ•"]},
    {id:5, name:"Ïï†ÎãàÌîåÎü¨Ïä§ Ìï©Ï†ï", address:"Î©îÏÑ∏ÎÇòÌè¥Î¶¨Ïä§ B2", hours:"10:00-22:00", lat:37.54959, lng:126.91352, icon:"üè¢", type:"Ï¢ÖÌï©", genres:["ÌîºÍ∑úÏñ¥","Ïó¨ÏÑ±Ìñ•","ÎÇ®ÏÑ±Ìñ•"]},
    {id:6, name:"Ïò§Î™®Ï∞®ÎûúÎìú", address:"ÏôÄÏö∞ÏÇ∞Î°ú29Í∏∏ 46", hours:"12:00-21:00", lat:37.55254, lng:126.92196, icon:"üé™", type:"Ï§ëÍ≥†", genres:["ÏïôÏä§ÌÉÄ","Ï§ëÍ≥†","ÎèÑÎ¶¨Î≤§"]},
    {id:7, name:"Íº¨Íº¨ÍµøÏ¶à", address:"ÏôÄÏö∞ÏÇ∞Î°ú27Í∏∏ 68 3Ï∏µ", hours:"13:00-20:30", lat:37.55268, lng:126.92297, icon:"üèê", type:"Ï¢ÖÌï©", genres:["ÌïòÏù¥ÌÅê","Ï£ºÏà†ÌöåÏ†Ñ","Ï†êÌîÑ"]},
    {id:8, name:"JSÏä§ÌÜ†Ïñ¥", address:"ÏûîÎã§Î¶¨Î°ú6Í∏∏ 28", hours:"12:00-20:30", lat:37.55393, lng:126.92087, icon:"ü§ñ", type:"ÌîºÍ∑úÏñ¥", genres:["ÏóêÎ∞òÍ≤åÎ¶¨Ïò®","Îã®Í∞ÑÎ°†Ìåå","ÏΩîÎìúÍ∏∞Ïñ¥Ïä§","Í∞ÄÏ±†"]},
    {id:9, name:"ÌîºÍ∑úÏñ¥ÌîÑÎ†åÏ¶à", address:"ÏñëÌôîÎ°ú18ÏïàÍ∏∏ 8 B1", hours:"13:00-21:00", lat:37.55392, lng:126.92360, icon:"üé≤", type:"ÌîºÍ∑úÏñ¥", genres:["ÌîºÍ∑úÏñ¥","ÎûúÎç§Íπ°","ÏßÄÎ•ò"]},
    {id:10, name:"ÏïàÏÑúÎãπ", address:"ÎèôÍµêÎèô 181-6 B1", hours:"12:00-20:00", lat:37.55481, lng:126.92305, icon:"üè™", type:"Ï§ëÍ≥†", genres:["Ï∫îÎ±ÉÏßÄ","ÏßÄÎ•ò","ÏòõÎÇ†ÍµøÏ¶à"]},
    {id:11, name:"Ìò∏ÏóêÎßàÏºì", address:"ÌôçÏùµÎ°ú6Í∏∏ 14", hours:"13:00-19:00", lat:37.55517, lng:126.92455, icon:"üå∏", type:"ÏÜåÌíà", genres:["ÏÇ∞Î¶¨Ïò§","ÏõêÌôîÍµøÏ¶à","Ï†êÌîÑÏÉµ"]},
    {id:12, name:"Ïï†ÎãàÏÑ∏Ïπ¥Ïù¥", address:"Ïñ¥Ïö∏ÎßàÎãπÎ°ú 155-1", hours:"12:00-21:00", lat:37.55392, lng:126.92262, icon:"üéÆ", type:"Ï¢ÖÌï©", genres:["Î°úÎ≥¥ÏΩî","Îç∞Ïä§ÎÖ∏Ìä∏","Ìù°ÌòàÍ∑Ä"]},
    {id:13, name:"Ìó¨Î°úÏàòÎØ∏ÏΩî", address:"ÏôÄÏö∞ÏÇ∞Î°ú29Í∏∏ 50", hours:"12:00-20:00", lat:37.55244, lng:126.92213, icon:"üé≤", type:"Í∞ÄÏ±†", genres:["Í∞ÄÏ±†","Ïù∏ÌòïÏò∑"]},
    {id:14, name:"ÎçîÏø†", address:"ÌôçÏùµÎ°ú6Í∏∏ 38 B1", hours:"12:00-21:00", lat:37.55502, lng:126.92373, icon:"üéÅ", type:"Ï¢ÖÌï©", genres:["Î¶¨Î©òÌä∏","ÏïôÏä§ÌÉÄ","ÌîÑÏÑ∏Ïπ¥"]},
    {id:15, name:"ÏºÄÏù¥Î∂ÅÏä§", address:"EXITÌôçÎåÄ B1", hours:"12:00-21:00", lat:37.55704, lng:126.92377, icon:"üìö", type:"Ï§ëÍ≥†", genres:["Ï§ëÍ≥†","ÎèôÏù∏ÏßÄ","ÌöåÏßÄ"]},
    {id:16, name:"Î∏åÎùºÎçîÍµøÏ¶à", address:"ÏôÄÏö∞ÏÇ∞Î°ú 94", hours:"12:00-20:00", lat:37.55403, lng:126.92181, icon:"‚öΩ", type:"Ï¢ÖÌï©", genres:["Î∏îÎ£®Î°ù","Ï£ºÏà†ÌöåÏ†Ñ","ÏÇ∞Î¶¨Ïò§","ÎãàÏºÄ"]},
    {id:17, name:"ÌîºÍ∑úÏñ¥ÌîÑÎ†àÏÜå FP", address:"ÏôÄÏö∞ÏÇ∞Î°ú29Í∏∏ 48-11", hours:"12:00-21:00", lat:37.55146, lng:126.92181, icon:"üé™", type:"ÌîºÍ∑úÏñ¥", genres:["Ï†úÏùºÎ≥µÍ∂å","ÌîºÍ∑úÏñ¥"]},
    {id:18, name:"Ïä§ÌéòÏù¥Ïä§ Ïö∞ÎùºÎùº", address:"ÌôçÎåÄÏûÖÍµ¨Ïó≠ ÏßÄÌïò", hours:"12:00-21:00", lat:37.55680, lng:126.92350, icon:"üöá", type:"Ï¢ÖÌï©", genres:["Ïù¥ÏπòÎ∞©Ïø†ÏßÄ","ÏóêÎ∞òÍ≤åÎ¶¨Ïò®"]},
    {id:19, name:"ÏõêÌîºÍ∑úÏñ¥", address:"ÌôçÏùµÎ°ú6Í∏∏ 14 2Ï∏µ", hours:"12:00-22:00", lat:37.55530, lng:126.92440, icon:"üéØ", type:"ÌîºÍ∑úÏñ¥", genres:["ÌîºÍ∑úÏñ¥","ÌååÎùºÎùºÏù¥","ÏûÖÎ¨∏"]},
    {id:20, name:"Ïò§Î™®Ï∞®ÎûúÎìú 2Ìò∏Ï†ê", address:"ÌôçÎåÄÏûÖÍµ¨Ïó≠ ÏßÄÌïò", hours:"12:00-21:00", lat:37.55690, lng:126.92380, icon:"üé™", type:"Ï§ëÍ≥†", genres:["ÏïôÏä§ÌÉÄ","Ïó¨ÏÑ±Ìñ•","Ï§ëÍ≥†"]},
    {id:21, name:"ÎëêÎãàÎ∂Ä", address:"ÏôÄÏö∞ÏÇ∞Î°ú13Í∏∏ 49", hours:"12:00-20:00", lat:37.55147, lng:126.92068, icon:"üé∏", type:"Ï¢ÖÌï©", genres:["ÏºÄÏù¥Ïò®","ÎßàÎßàÎßà","Í≥†Ï†Ñ"]},
    {id:22, name:"ÏïÑÏù¥ÎÖ∏Î™®ÎÖ∏", address:"ÏûîÎã§Î¶¨Î°ú6Í∏∏ 36", hours:"12:00-21:00", lat:37.55430, lng:126.92150, icon:"üí´", type:"ÏÜåÌíà", genres:["Ï∫êÏ∫êÏ≤¥","Í±∏Î∞¥ÌÅ¨","Ìù¨Í∑ÄÏû•Î•¥"]},
    {id:23, name:"Ïï†ÎãàÌîåÎùºÏûê", address:"ÏôÄÏö∞ÏÇ∞Î°ú29Í∏∏ 42", hours:"11:00-21:00", lat:37.55264, lng:126.92203, icon:"üé´", type:"ÎÇ®ÏÑ±Ìñ•", genres:["Ï†úÏùºÎ≥µÍ∂å","ÎÇ®ÏÑ±Ìñ•","ÌîºÍ∑úÏñ¥"]},
    {id:24, name:"ÌîºÍ∑úÏñ¥ÌîÑÎ†àÏÜå ÌôçÎåÄ", address:"ÏûîÎã§Î¶¨Î°ú6Í∏∏ 25", hours:"12:00-21:00", lat:37.55352, lng:126.92247, icon:"üé∞", type:"ÌîºÍ∑úÏñ¥", genres:["Ï†úÏùºÎ≥µÍ∂å","ÌîºÍ∑úÏñ¥"]},
    {id:25, name:"ÎùºÏã†Î∞ò", address:"AKÌîåÎùºÏûê", hours:"12:00-20:00", lat:37.55658, lng:126.92366, icon:"üìñ", type:"Ï§ëÍ≥†", genres:["Ìè¨Ïπ¥","ÌöåÏßÄ","Ï∫îÎ±ÉÏßÄ"]}
];

const questions = [
    {
        text: "Ïñ¥Îñ§ ÍµøÏ¶àÎ•º Ï£ºÎ°ú Ï∞æÏïÑ?",
        options: [
            {icon: "ü§ñ", main: "ÌîºÍ∑úÏñ¥ / Î≥µÍ∂å", sub: "Ï†úÏùºÎ≥µÍ∂å, ÌîÑÎùºÎ™®Îç∏, ÎÑ®ÎèÑÎ°úÏù¥Îìú", value: "figure"},
            {icon: "üíñ", main: "Ïó¨ÏÑ±Ìñ•", sub: "ÏïôÏä§ÌÉÄ, Î∏îÎ£®Î°ù, ÌïòÏù¥ÌÅê", value: "female"},
            {icon: "üî•", main: "ÎÇ®ÏÑ±Ìñ•", sub: "ÏóêÎ∞òÍ≤åÎ¶¨Ïò®, ÌîºÍ∑úÏñ¥", value: "male"},
            {icon: "üåü", main: "Îã§ Ï¢ãÏïÑ!", sub: "Í≥®Í≥†Î£® Íµ¨Í≤ΩÌï†Îûò", value: "all"}
        ]
    },
    {
        text: "ÍµøÏ¶àÏÉµ Í≤ΩÌóòÏùÄ?",
        options: [
            {icon: "üê£", main: "Ï≤òÏùåÏù¥Ïïº", sub: "Í∏∞Î≥∏Î∂ÄÌÑ∞ ÏïåÎ†§Ï§ò", value: "beginner"},
            {icon: "üê•", main: "Î™á Î≤à ÏôÄÎ¥§Ïñ¥", sub: "Ïñ¥Îäê Ï†ïÎèÑ ÏïåÏïÑ", value: "intermediate"},
            {icon: "ü¶Ö", main: "Îã®Í≥®Ïù¥ÏßÄ", sub: "Ïà®ÏùÄ ÎßõÏßë Ï∞æÏïÑÏ§ò", value: "expert"}
        ]
    }
];

// ÏÉÅÌÉú
let map, freeMap, userLocation = null, userMarker = null, freeUserMarker = null;
let currentQuestion = 0;
let answers = {};
let recommendedShops = [];
let currentIndex = 0;
let sessionVisited = new Set();
let tourMode = false;
let startTime = null;
let isDarkMode = true;

const STORAGE_KEY = 'hongdae_goods_v4';
let savedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{"visitedShops":[],"totalVisits":0,"reviews":{}}');

// Îã§ÌÅ¨/ÎùºÏù¥Ìä∏ Î™®Îìú
function toggleTheme() {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('light-mode', !isDarkMode);
    document.querySelectorAll('.theme-toggle, .theme-btn').forEach(btn => {
        btn.textContent = isDarkMode ? 'üåô Îã§ÌÅ¨Î™®Îìú' : '‚òÄÔ∏è ÎùºÏù¥Ìä∏Î™®Îìú';
    });
    
    // ÏßÄÎèÑ Ïä§ÌÉÄÏùº ÏóÖÎç∞Ïù¥Ìä∏
    if (map) updateMapStyle(map);
    if (freeMap) updateMapStyle(freeMap);
}

function updateMapStyle(mapInstance) {
    const darkStyles = [
        {elementType: "geometry", stylers: [{color: "#1d1d1f"}]},
        {elementType: "labels.text.fill", stylers: [{color: "#8e8e93"}]},
        {featureType: "road", elementType: "geometry", stylers: [{color: "#2c2c2e"}]},
        {featureType: "poi", stylers: [{visibility: "off"}]},
        {featureType: "water", stylers: [{color: "#0e0e0e"}]}
    ];
    const lightStyles = [
        {featureType: "poi", stylers: [{visibility: "off"}]}
    ];
    mapInstance.setOptions({ styles: isDarkMode ? darkStyles : lightStyles });
}

// Ïú†Ìã∏
function calcDist(lat1, lng1, lat2, lng2) {
    const R = 6371000;
    const dLat = (lat2-lat1) * Math.PI/180;
    const dLng = (lng2-lng1) * Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function formatDist(m) { return m < 1000 ? Math.round(m) + 'm' : (m/1000).toFixed(1) + 'km'; }
function formatWalk(m) { const mins = Math.round(m / 67); return mins < 1 ? '1Î∂Ñ' : mins + 'Î∂Ñ'; }

function updateDistances() {
    if (!userLocation) return;
    shops.forEach(s => {
        s.dist = calcDist(userLocation.lat, userLocation.lng, s.lat, s.lng);
        s.distText = formatDist(s.dist);
        s.walkTime = formatWalk(s.dist);
    });
}

function getShopStatus(shop) {
    const now = new Date();
    const h = now.getHours();
    const m = now.getMinutes();
    const currentMins = h * 60 + m;
    
    const [open, close] = shop.hours.split('-');
    const [oh, om] = open.split(':').map(Number);
    const [ch, cm] = close.split(':').map(Number);
    const openMins = oh * 60 + om;
    const closeMins = ch * 60 + cm;
    
    if (currentMins < openMins) {
        const diff = openMins - currentMins;
        if (diff <= 60) return { status: 'soon', text: `${diff}Î∂Ñ ÌõÑ Ïò§Ìîà` };
        return { status: 'closed', text: 'ÏòÅÏóÖ Ï†Ñ' };
    }
    if (currentMins >= closeMins) return { status: 'closed', text: 'ÏòÅÏóÖ Ï¢ÖÎ£å' };
    const remaining = closeMins - currentMins;
    if (remaining <= 60) return { status: 'open', text: `${remaining}Î∂Ñ ÌõÑ ÎßàÍ∞ê` };
    return { status: 'open', text: 'ÏòÅÏóÖÏ§ë' };
}

function isVisited(shopId) { return savedData.visitedShops.includes(shopId); }

function markVisited(shopId) {
    if (!savedData.visitedShops.includes(shopId)) {
        savedData.visitedShops.push(shopId);
        saveData();
    }
    sessionVisited.add(shopId);
}

function unmarkVisitedPermanent(shopId) {
    savedData.visitedShops = savedData.visitedShops.filter(id => id !== shopId);
    saveData();
}

function unmarkVisited(shopId) { sessionVisited.delete(shopId); }

function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
}

function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(savedData)); }

// ÌïúÏ§ÑÌèâ
function getReviews(shopId) { return savedData.reviews[shopId] || []; }

function addReview(shopId, text) {
    if (!savedData.reviews[shopId]) savedData.reviews[shopId] = [];
    savedData.reviews[shopId].unshift({
        text,
        date: new Date().toLocaleDateString('ko-KR')
    });
    if (savedData.reviews[shopId].length > 10) savedData.reviews[shopId].pop();
    saveData();
}

// Ïù∏Ìä∏Î°ú
function startOnboarding() {
    document.getElementById('intro').classList.add('hidden');
    document.getElementById('onboarding').classList.add('show');
    currentQuestion = 0;
    renderQuestion();
}

function startFreeMode() {
    document.getElementById('intro').classList.add('hidden');
    document.getElementById('freeApp').classList.add('show');
    
    updateFreeStats();
    
    setTimeout(() => {
        initFreeMap();
        setTimeout(() => {
            if (freeMap) {
                google.maps.event.trigger(freeMap, 'resize');
                freeMap.setCenter({lat: 37.555, lng: 126.922});
                freeMap.setZoom(16);
            }
        }, 300);
    }, 100);
}

function closeFreeMode() {
    document.getElementById('freeApp').classList.remove('show');
    document.getElementById('intro').classList.remove('hidden');
}

// Ïò®Î≥¥Îî©
function renderQuestion() {
    const q = questions[currentQuestion];
    document.getElementById('progressFill').style.width = ((currentQuestion + 1) / questions.length * 100) + '%';
    
    document.getElementById('questionContent').innerHTML = `
        <div class="question-num">ÏßàÎ¨∏ ${currentQuestion + 1}/${questions.length}</div>
        <div class="question-text">${q.text}</div>
        <div class="options">
            ${q.options.map((opt, i) => `
                <button class="option-btn" onclick="selectOption(${i}, '${opt.value}')">
                    <div class="option-icon">${opt.icon}</div>
                    <div class="option-text">
                        <span class="main">${opt.main}</span>
                        <span class="sub">${opt.sub}</span>
                    </div>
                </button>
            `).join('')}
        </div>
    `;
}

function selectOption(idx, value) {
    document.querySelectorAll('.option-btn').forEach((b, i) => b.classList.toggle('selected', i === idx));
    answers[currentQuestion] = value;
    
    setTimeout(() => {
        if (currentQuestion < questions.length - 1) {
            currentQuestion++;
            renderQuestion();
        } else {
            generateRecommendation();
        }
    }, 300);
}

function skipOnboarding() {
    answers = {0: 'all', 1: 'beginner'};
    generateRecommendation();
}

function backToOnboarding() {
    document.getElementById('resultScreen').classList.remove('show');
    document.getElementById('onboarding').classList.add('show');
    currentQuestion = 0;
    renderQuestion();
}

// Ï∂îÏ≤ú ÏÉùÏÑ±
function generateRecommendation() {
    document.getElementById('onboarding').classList.remove('show');
    
    const genre = answers[0] || 'all';
    const level = answers[1] || 'beginner';
    
    let title = '', desc = '', reasons = [];
    let filtered = [];
    
    const unvisited = shops.filter(s => !isVisited(s.id));
    
    if (genre === 'figure') {
        title = 'ü§ñ ÌîºÍ∑úÏñ¥ ÌóåÌÑ∞ ÏΩîÏä§';
        desc = 'ÌîºÍ∑úÏñ¥ÏôÄ Î≥µÍ∂å Ï∞æÎäî ÎãπÏã†ÏùÑ ÏúÑÌïú ÏΩîÏä§';
        filtered = unvisited.filter(s => s.genres.some(g => ['ÌîºÍ∑úÏñ¥','Ï†úÏùºÎ≥µÍ∂å','ÏóêÎ∞òÍ≤åÎ¶¨Ïò®','Í∞ÄÏ±†'].includes(g)));
        reasons = ['Ï†úÏùºÎ≥µÍ∂å ÏûàÎäî Í≥≥ ÏúÑÏ£º', 'ÌîºÍ∑úÏñ¥ Ï¢ÖÎ•ò ÎßéÏùÄ Îß§Ïû•', 'Í∞ÄÍ≤©ÎåÄ Îã§Ïñë'];
    } else if (genre === 'female') {
        title = 'üíñ Ïó¨ÏÑ±Ìñ• ÏÑ±ÏßÄÏàúÎ°Ä';
        desc = 'ÏïôÏä§ÌÉÄ, Î∏îÎ£®Î°ù, ÌïòÏù¥ÌÅê ÎçïÌõÑ ÏΩîÏä§';
        filtered = unvisited.filter(s => s.genres.some(g => ['ÏïôÏä§ÌÉÄ','Î∏îÎ£®Î°ù','ÌïòÏù¥ÌÅê','Ïó¨ÏÑ±Ìñ•','Ï£ºÏà†ÌöåÏ†Ñ'].includes(g)));
        reasons = ['ÏïôÏä§ÌÉÄ/Î∏îÎ£®Î°ù ÎßéÏùÄ Í≥≥', 'Ïù¥ÏπòÎ∞©Ïø†ÏßÄ Í∞ÄÎä•', 'Ï§ëÍ≥†ÏÉµ Ìè¨Ìï®'];
    } else if (genre === 'male') {
        title = 'üî• ÎÇ®ÏÑ±Ìñ• ÌíÄÏΩîÏä§';
        desc = 'ÎÇ®ÏÑ±Ìñ• ÍµøÏ¶àÏôÄ ÌîºÍ∑úÏñ¥ ÏΩîÏä§';
        filtered = unvisited.filter(s => s.genres.some(g => ['ÎÇ®ÏÑ±Ìñ•','ÏóêÎ∞òÍ≤åÎ¶¨Ïò®','Ï†úÏùºÎ≥µÍ∂å'].includes(g)));
        reasons = ['ÎÇ®ÏÑ±Ìñ• ÌäπÌôî Îß§Ïû•', 'Ï†úÏùºÎ≥µÍ∂å Ï¢ÖÎ•ò Îã§Ïñë', 'Í∞ÄÍ≤© Ï†ÄÎ†¥Ìïú Í≥≥ Ìè¨Ìï®'];
    } else {
        title = 'üåü ÌôçÎåÄ ÍµøÏ¶àÏÉµ Ìà¨Ïñ¥';
        desc = 'Îã§ÏñëÌïú Ïû•Î•¥ Í≥®Í≥†Î£® Ï¶êÍ∏∞Îäî ÏΩîÏä§';
        filtered = unvisited.filter(s => s.type === 'Ï¢ÖÌï©');
        reasons = ['Ï¢ÖÌï© Îß§Ïû• ÏúÑÏ£º', 'Í∑úÎ™® ÌÅ∞ Í≥≥ Ïö∞ÏÑ†', 'Îã§ÏñëÌïú Ïû•Î•¥'];
    }

    if (level === 'expert') {
        const rare = unvisited.filter(s => s.type === 'Ï§ëÍ≥†' || s.genres.includes('Ìù¨Í∑ÄÏû•Î•¥'));
        filtered = [...filtered, ...rare];
        reasons.push('Ïà®ÏùÄ ÎßõÏßë/Ï§ëÍ≥†ÏÉµ Ìè¨Ìï®');
    }

    if (savedData.visitedShops.length > 0) reasons.push('Ïù¥ÎØ∏ Í∞Ñ Í≥≥ÏùÄ Ï†úÏô∏ÌñàÏñ¥Ïöî');

    if (filtered.length < 5) {
        const remaining = unvisited.filter(s => !filtered.includes(s));
        filtered = [...filtered, ...remaining];
    }

    filtered.sort((a, b) => {
        const aStatus = getShopStatus(a).status === 'open' ? 0 : 1;
        const bStatus = getShopStatus(b).status === 'open' ? 0 : 1;
        if (aStatus !== bStatus) return aStatus - bStatus;
        return (a.dist || 0) - (b.dist || 0);
    });

    recommendedShops = filtered.slice(0, 5);

    document.getElementById('resultContent').innerHTML = `
        <div class="ai-card">
            <div class="ai-badge">‚ú® AI ÎßûÏ∂§ Ï∂îÏ≤ú</div>
            <div class="ai-title">${title}</div>
            <div class="ai-desc">${desc}</div>
            <div class="ai-reasons">
                <div class="ai-reasons-title">Ïù¥Î†áÍ≤å Ï∂îÏ≤úÌïú Ïù¥Ïú†</div>
                ${reasons.map(r => `<div class="reason-item"><div class="reason-icon">‚úì</div><span>${r}</span></div>`).join('')}
            </div>
        </div>
        
        <div class="section-title"><span>Ï∂îÏ≤ú ÏàúÏÑú</span><span class="shop-count">${recommendedShops.length}Í≥≥</span></div>
        
        ${recommendedShops.map((shop, i) => {
            const status = getShopStatus(shop);
            return `
            <div class="shop-card ${i === 0 ? 'first' : ''}" onclick="openModal(${shop.id})">
                <div class="shop-photo">
                    ${shop.icon}
                    <div class="shop-status ${status.status}">${status.text}</div>
                    <div class="shop-rank-badge">${i + 1}</div>
                </div>
                <div class="shop-body">
                    <div class="shop-name-row">
                        <span class="shop-name">${shop.name}</span>
                    </div>
                    <div class="shop-meta">
                        <span>üìç ${shop.address}</span>
                        <span>üïê ${shop.hours}</span>
                        ${shop.walkTime ? `<span>üö∂ ${shop.walkTime}</span>` : ''}
                    </div>
                    <div class="shop-genres">
                        ${shop.genres.slice(0, 4).map(g => `<span class="genre-tag">#${g}</span>`).join('')}
                    </div>
                </div>
            </div>
        `}).join('')}
    `;
    
    document.getElementById('resultScreen').classList.add('show');
}

// ÌÉêÎ∞©
function startTour() {
    tourMode = true;
    currentIndex = 0;
    sessionVisited.clear();
    startTime = Date.now();
    
    document.getElementById('resultScreen').classList.remove('show');
    document.getElementById('app').classList.add('show');
    
    setTimeout(() => {
        if (map) google.maps.event.trigger(map, 'resize');
        updateCurrentDest();
        updateMap();
    }, 100);
}

function updateCurrentDest() {
    const shop = recommendedShops[currentIndex];
    const next = recommendedShops[currentIndex + 1];
    const status = getShopStatus(shop);
    const isCurrentVisited = sessionVisited.has(shop.id);
    
    const stamps = recommendedShops.map((s, i) => 
        `<div class="stamp ${sessionVisited.has(s.id) ? 'done' : i === currentIndex ? 'current' : ''}">${sessionVisited.has(s.id) ? '‚úì' : i + 1}</div>`
    ).join('');
    
    document.getElementById('currentDest').innerHTML = `
        <div class="dest-label">
            <span class="live-dot"></span>
            <span>${currentIndex + 1}/${recommendedShops.length} Î≤àÏß∏</span>
            <div class="stamps">${stamps}</div>
        </div>
        <div class="dest-shop">
            <div class="dest-photo">${shop.icon}</div>
            <div class="dest-info">
                <h2>${shop.name}</h2>
                <p>${shop.address}</p>
            </div>
            <div class="dest-walk">${shop.walkTime || '-'}</div>
        </div>
        <div class="dest-status-bar">
            <span class="status ${status.status}">${status.text}</span>
            <span class="hours">üïê ${shop.hours}</span>
        </div>
        <div class="dest-genres">
            ${shop.genres.slice(0, 4).map(g => `<span class="genre-tag">#${g}</span>`).join('')}
        </div>
        <div class="dest-actions">
            ${isCurrentVisited ? `
                <button class="action-btn danger" onclick="undoComplete()">‚Ü© Ï∑®ÏÜå</button>
                <button class="action-btn primary" onclick="nextShop()">Îã§Ïùå ‚Üí</button>
            ` : `
                <button class="action-btn secondary" onclick="openModal(${shop.id})">ÏÉÅÏÑ∏</button>
                <button class="action-btn success" onclick="completeShop()">‚úì ÎèÑÏ∞©</button>
            `}
        </div>
    `;
    
    document.getElementById('mapStatus').innerHTML = `
        <div class="map-status-icon">${shop.icon}</div>
        <div class="map-status-text">
            <div class="title">${shop.name}</div>
            <div class="sub">${shop.distText || '-'}</div>
        </div>
        <span class="map-status-badge ${status.status}">${status.text}</span>
    `;
    
    if (next) {
        const distToNext = calcDist(shop.lat, shop.lng, next.lat, next.lng);
        document.getElementById('nextPreview').innerHTML = `
            <div class="next-icon">${next.icon}</div>
            <div class="next-info">
                <div class="label">Îã§Ïùå Ïû•ÏÜå</div>
                <h4>${next.name}</h4>
            </div>
            <div class="next-walk">‚Üí ${formatWalk(distToNext)}</div>
        `;
        document.getElementById('nextPreview').style.display = 'flex';
    } else {
        document.getElementById('nextPreview').innerHTML = `<div class="next-info" style="width:100%;text-align:center"><div class="label">üéâ ÎßàÏßÄÎßâ!</div></div>`;
    }
}

function completeShop() {
    markVisited(recommendedShops[currentIndex].id);
    showToast(`‚úì ${recommendedShops[currentIndex].name} ÏôÑÎ£å!`);
    updateCurrentDest();
    updateMap();
    
    if (recommendedShops.every(s => sessionVisited.has(s.id))) {
        setTimeout(() => showComplete(), 500);
    }
}

function undoComplete() {
    unmarkVisited(recommendedShops[currentIndex].id);
    showToast(`‚Ü© Ï∑®ÏÜåÎê®`);
    updateCurrentDest();
    updateMap();
}

function nextShop() {
    if (currentIndex < recommendedShops.length - 1) {
        currentIndex++;
        updateCurrentDest();
        updateMap();
    } else {
        showComplete();
    }
}

function showComplete() {
    const visitedList = recommendedShops.filter(s => sessionVisited.has(s.id));
    savedData.totalVisits++;
    saveData();
    
    document.getElementById('completeSubtext').textContent = `${visitedList.length}Í≥≥ Î∞©Î¨∏ ÏôÑÎ£å`;
    document.getElementById('completeContent').innerHTML = visitedList.map(shop => `
        <div class="complete-shop-card">
            <div class="complete-shop-icon">${shop.icon}</div>
            <div class="complete-shop-info">
                <h3>${shop.name}</h3>
                <p>${shop.address}</p>
            </div>
        </div>
    `).join('');
    
    document.getElementById('app').classList.remove('show');
    document.getElementById('completeScreen').classList.add('show');
}

function viewAllMap() {
    document.getElementById('completeScreen').classList.remove('show');
    document.getElementById('freeApp').classList.add('show');
    
    updateFreeStats();
    
    setTimeout(() => {
        initFreeMap();
        setTimeout(() => {
            if (freeMap) {
                google.maps.event.trigger(freeMap, 'resize');
                freeMap.setCenter({lat: 37.555, lng: 126.922});
                freeMap.setZoom(16);
            }
        }, 300);
    }, 100);
}

// ÏßÄÎèÑ
const darkMapStyles = [
    {elementType: "geometry", stylers: [{color: "#1d1d1f"}]},
    {elementType: "labels.text.fill", stylers: [{color: "#8e8e93"}]},
    {featureType: "road", elementType: "geometry", stylers: [{color: "#2c2c2e"}]},
    {featureType: "poi", stylers: [{visibility: "off"}]},
    {featureType: "water", stylers: [{color: "#0e0e0e"}]}
];

function initApp() {
    map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 37.555, lng: 126.922},
        zoom: 16,
        disableDefaultUI: true,
        zoomControl: true,
        gestureHandling: 'greedy',
        styles: darkMapStyles
    });
    startTracking();
}

function initFreeMap() {
    const mapDiv = document.getElementById('freeMap');
    if (!mapDiv) return;
    
    if (freeMap) {
        updateFreeMap();
        return;
    }
    
    freeMap = new google.maps.Map(mapDiv, {
        center: {lat: 37.555, lng: 126.922},
        zoom: 16,
        disableDefaultUI: true,
        zoomControl: true,
        gestureHandling: 'greedy',
        styles: isDarkMode ? darkMapStyles : [{featureType: "poi", stylers: [{visibility: "off"}]}]
    });
    
    google.maps.event.addListenerOnce(freeMap, 'idle', () => updateFreeMap());
}

function updateFreeStats() {
    const visited = savedData.visitedShops.length;
    const total = shops.length;
    document.getElementById('freeStats').innerHTML = `
        <div class="stat-item">Ï†ÑÏ≤¥ <strong>${total}</strong>Í≥≥</div>
        <div class="stat-item">Î∞©Î¨∏ <strong>${visited}</strong>Í≥≥</div>
        <div class="stat-item">ÎØ∏Î∞©Î¨∏ <strong>${total - visited}</strong>Í≥≥</div>
    `;
}

function updateFreeMap() {
    if (!freeMap) return;
    
    if (window.freeMarkers) window.freeMarkers.forEach(m => m.setMap(null));
    window.freeMarkers = [];
    
    const bounds = new google.maps.LatLngBounds();
    
    shops.forEach(shop => {
        const visited = isVisited(shop.id);
        const status = getShopStatus(shop);
        
        const marker = new google.maps.Marker({
            position: {lat: shop.lat, lng: shop.lng},
            map: freeMap,
            icon: {
                url: `data:image/svg+xml,${encodeURIComponent(`
                    <svg width="40" height="48" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="18" fill="${visited ? '#30d158' : status.status === 'open' ? '#333' : '#666'}" stroke="${visited ? '#fff' : status.status === 'open' ? '#fff' : '#999'}" stroke-width="2"/>
                        <text x="20" y="27" font-size="16" text-anchor="middle">${visited ? '‚úì' : shop.icon}</text>
                    </svg>
                `)}`,
                scaledSize: new google.maps.Size(40, 48),
                anchor: new google.maps.Point(20, 24)
            },
            zIndex: visited ? 100 : 200
        });
        
        marker.addListener('click', () => openModal(shop.id));
        window.freeMarkers.push(marker);
        bounds.extend({lat: shop.lat, lng: shop.lng});
    });
    
    if (userLocation) {
        bounds.extend(userLocation);
        if (!freeUserMarker) {
            freeUserMarker = new google.maps.Marker({
                position: userLocation,
                map: freeMap,
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 10, fillColor: '#007aff', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 3 },
                zIndex: 1000
            });
        } else {
            freeUserMarker.setMap(freeMap);
            freeUserMarker.setPosition(userLocation);
        }
    }
}

function startTracking() {
    if (!navigator.geolocation) return;
    navigator.geolocation.watchPosition(
        pos => {
            userLocation = {lat: pos.coords.latitude, lng: pos.coords.longitude};
            updateDistances();
            
            if (map && !userMarker) {
                userMarker = new google.maps.Marker({
                    position: userLocation,
                    map,
                    icon: { path: google.maps.SymbolPath.CIRCLE, scale: 10, fillColor: '#007aff', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 3 },
                    zIndex: 1000
                });
            } else if (userMarker) {
                userMarker.setPosition(userLocation);
            }
            
            if (freeUserMarker) freeUserMarker.setPosition(userLocation);
            if (tourMode) updateCurrentDest();
        },
        () => {},
        {enableHighAccuracy: true, timeout: 15000, maximumAge: 0}
    );
}

function updateMap() {
    if (!map) return;
    if (window.shopMarkers) window.shopMarkers.forEach(m => m.setMap(null));
    if (window.routeLine) window.routeLine.setMap(null);
    window.shopMarkers = [];
    
    const bounds = new google.maps.LatLngBounds();
    if (userLocation) bounds.extend(userLocation);
    
    const pathCoords = userLocation ? [userLocation] : [];
    
    recommendedShops.forEach((shop, idx) => {
        const isCurrent = idx === currentIndex;
        const isDone = sessionVisited.has(shop.id);
        
        const marker = new google.maps.Marker({
            position: {lat: shop.lat, lng: shop.lng},
            map,
            icon: {
                url: `data:image/svg+xml,${encodeURIComponent(`
                    <svg width="48" height="56" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="24" cy="24" r="22" fill="${isDone ? '#30d158' : isCurrent ? '#007aff' : '#333'}" stroke="white" stroke-width="3"/>
                        <text x="24" y="31" font-size="22" text-anchor="middle" fill="white">${isDone ? '‚úì' : shop.icon}</text>
                        ${isCurrent && !isDone ? '<circle cx="24" cy="24" r="22" fill="none" stroke="#007aff" stroke-width="3" opacity="0.5"><animate attributeName="r" from="22" to="32" dur="1.5s" repeatCount="indefinite"/><animate attributeName="opacity" from="0.5" to="0" dur="1.5s" repeatCount="indefinite"/></circle>' : ''}
                    </svg>
                `)}`,
                scaledSize: new google.maps.Size(48, 56),
                anchor: new google.maps.Point(24, 28)
            },
            zIndex: isCurrent ? 500 : 100
        });
        
        marker.addListener('click', () => openModal(shop.id));
        window.shopMarkers.push(marker);
        bounds.extend({lat: shop.lat, lng: shop.lng});
        pathCoords.push({lat: shop.lat, lng: shop.lng});
    });
    
    window.routeLine = new google.maps.Polyline({
        path: pathCoords,
        geodesic: true,
        strokeColor: '#007aff',
        strokeOpacity: 0,
        icons: [{icon: {path: 'M 0,-1 0,1', strokeOpacity: 0.6, scale: 3}, offset: '0', repeat: '15px'}]
    });
    window.routeLine.setMap(map);
    map.fitBounds(bounds, 80);
}

function goToMyLocation() {
    if (userLocation && map) { map.panTo(userLocation); map.setZoom(17); }
}

function goToMyLocationFree() {
    if (userLocation && freeMap) { freeMap.panTo(userLocation); freeMap.setZoom(17); }
}

// Î™®Îã¨
function openModal(shopId) {
    const shop = shops.find(s => s.id === shopId);
    if (!shop) return;
    const status = getShopStatus(shop);
    const visited = isVisited(shop.id);
    const reviews = getReviews(shop.id);
    
    document.getElementById('modalContent').innerHTML = `
        <div class="modal-photo">
            ${shop.icon}
            <span class="modal-status ${status.status}">${status.text}</span>
        </div>
        
        <div class="modal-title-row">
            <span class="modal-title">${shop.name}</span>
            ${visited ? '<span class="genre-tag" style="background:var(--success);color:#fff;">‚úì Î∞©Î¨∏Ìï®</span>' : ''}
        </div>
        
        <div class="modal-meta">
            <span>üìç ${shop.address}</span>
            ${shop.walkTime ? `<span>üö∂ ${shop.walkTime}</span>` : ''}
        </div>
        
        <div class="modal-genres">
            ${shop.genres.map(g => `<span class="genre-tag">#${g}</span>`).join('')}
        </div>
        
        <div class="modal-info">
            <div class="modal-info-row"><span class="icon">üïê</span>${shop.hours}</div>
            <div class="modal-info-row"><span class="icon">üè∑</span>${shop.type}</div>
            ${shop.distText ? `<div class="modal-info-row"><span class="icon">üìç</span>${shop.distText}</div>` : ''}
        </div>
        
        <div class="review-section">
            <div class="review-title">üí¨ ÌïúÏ§ÑÌèâ</div>
            <div class="review-input-wrap">
                <input type="text" class="review-input" id="reviewInput" placeholder="ÌïúÏ§ÑÌèâÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî" maxlength="50">
                <button class="review-submit" onclick="submitReview(${shop.id})">Îì±Î°ù</button>
            </div>
            <div class="review-list">
                ${reviews.length > 0 ? reviews.map(r => `
                    <div class="review-item">
                        ${r.text}
                        <div class="date">${r.date}</div>
                    </div>
                `).join('') : '<div style="color:var(--text-sub);font-size:13px;">ÏïÑÏßÅ ÌïúÏ§ÑÌèâÏù¥ ÏóÜÏñ¥Ïöî</div>'}
            </div>
        </div>
        
        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="closeModal()">Îã´Í∏∞</button>
            ${visited 
                ? `<button class="modal-btn danger" onclick="unmarkVisitedFromModal(${shop.id})">Î∞©Î¨∏ Ï∑®ÏÜå</button>`
                : `<button class="modal-btn success" onclick="markVisitedFromModal(${shop.id})">‚úì Î∞©Î¨∏ ÏôÑÎ£å</button>`
            }
        </div>
    `;
    document.getElementById('modal').classList.add('show');
}

function submitReview(shopId) {
    const input = document.getElementById('reviewInput');
    const text = input.value.trim();
    if (!text) return;
    
    addReview(shopId, text);
    showToast('üí¨ ÌïúÏ§ÑÌèâ Îì±Î°ùÎê®');
    openModal(shopId); // ÏÉàÎ°úÍ≥†Ïπ®
}

function markVisitedFromModal(shopId) {
    markVisited(shopId);
    showToast('‚úì Î∞©Î¨∏ ÏôÑÎ£åÎ°ú Ï†ÄÏû•Îê®');
    closeModal();
    if (freeMap) { updateFreeMap(); updateFreeStats(); }
}

function unmarkVisitedFromModal(shopId) {
    unmarkVisitedPermanent(shopId);
    showToast('‚Ü© Î∞©Î¨∏ Í∏∞Î°ù ÏÇ≠Ï†úÎê®');
    closeModal();
    if (freeMap) { updateFreeMap(); updateFreeStats(); }
}

function closeModal(e) {
    if (e && e.target.id !== 'modal') return;
    document.getElementById('modal').classList.remove('show');
}

function shareCourse() {
    const text = `üé≠ ÌôçÎåÄ ÍµøÏ¶àÏÉµ Ï∂îÏ≤ú\n\n${recommendedShops.map((s, i) => `${i+1}. ${s.name}`).join('\n')}\n\n#ÌôçÎåÄÍµøÏ¶àÏÉµ`;
    if (navigator.share) navigator.share({title: 'ÌôçÎåÄ ÍµøÏ¶àÏÉµ', text});
    else { navigator.clipboard.writeText(text); showToast('üìã Î≥µÏÇ¨Îê®!'); }
}

function resetApp() { location.reload(); }
</script>

</body>
</html>
